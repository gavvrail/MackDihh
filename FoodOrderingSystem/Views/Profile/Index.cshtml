@model FoodOrderingSystem.Controllers.ProfileViewModel
@using Microsoft.AspNetCore.Identity
@inject UserManager<ApplicationUser> UserManager

@{
    ViewData["Title"] = "My Profile";
}

@section Styles {
    <link rel="stylesheet" href="~/css/profile.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/image-upload.css" asp-append-version="true" />
}

<div class="profile-container">
    <div class="container">
        <!-- Profile Header Section -->
        <div class="profile-header">
            <div class="row align-items-center">
                <div class="col-md-3 text-center">
                    <div class="profile-image-section">
                        <div class="profile-image-container">
                            <img id="profile-photo" 
                                 src="@(string.IsNullOrEmpty(ViewBag.ProfilePhotoUrl) ? "/images/default-profile.png" : ViewBag.ProfilePhotoUrl)" 
                                 alt="Profile Photo" 
                                 class="rounded-circle profile-photo"
                                 onerror="this.src='/images/default-profile.png';">
                            <div class="profile-edit-overlay">
                                <i class="fas fa-camera"></i>
                            </div>
                            <input type="file" id="profile-photo-input" accept="image/*" style="display: none;">
                        </div>
                        
                        <!-- Crop Interface (Hidden by default) -->
                        <div class="crop-interface" id="cropInterface" style="display: none;">
                            <div class="crop-preview-container">
                                <img id="cropImage" src="" alt="Crop Preview" style="max-width: 100%; max-height: 300px;">
                            </div>
                            <div class="crop-controls mt-3">
                                <button type="button" class="btn btn-success me-2" id="saveCropBtn">
                                    <i class="fas fa-check me-1"></i>Save
                                </button>
                                <button type="button" class="btn btn-secondary" id="cancelCropBtn">
                                    <i class="fas fa-times me-1"></i>Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-9">
                    <div class="profile-info">
                        <h1 class="profile-name">@Model.UserName</h1>
                        <p class="profile-email">
                            <i class="fas fa-envelope me-2"></i>@Model.Email
                            @if (Model.IsEmailConfirmed)
                            {
                                <span class="badge bg-success ms-2"><i class="fas fa-check me-1"></i>Verified</span>
                            }
                            else
                            {
                                <span class="badge bg-warning ms-2"><i class="fas fa-exclamation-triangle me-1"></i>Unverified</span>
                            }
                        </p>
                        @if (!string.IsNullOrEmpty(Model.PhoneNumber))
                        {
                            <p class="profile-phone">
                                <i class="fas fa-phone me-2"></i>@Model.PhoneNumber
                            </p>
                        }
                        @if (ViewBag.IsAdmin)
                        {
                            <div class="admin-badge">
                                <span class="badge bg-danger fs-6">
                                    <i class="fas fa-crown me-1"></i>Administrator
                                </span>
                            </div>
                        }
                        else
                        {
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Alerts Section -->
        @if (TempData["SuccessMessage"] != null)
        {
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="fas fa-check-circle me-2"></i>@TempData["SuccessMessage"]
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        }
        
        @if (TempData["InfoMessage"] != null)
        {
            <div class="alert alert-info alert-dismissible fade show" role="alert">
                <i class="fas fa-info-circle me-2"></i>@TempData["InfoMessage"]
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        }

        <div class="row">
            <div class="col-lg-8">
                <!-- Main Profile Card -->
                <div class="card profile-main-card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-user-edit me-2"></i>Profile Information
                        </h5>
                    </div>
                    <div class="card-body">


                        <form asp-action="Update" method="post">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label asp-for="UserName" class="form-label">Username *</label>
                                        <input asp-for="UserName" class="form-control" placeholder="Enter username" />
                                        <span asp-validation-for="UserName" class="text-danger"></span>
                                    </div>

                                    <div class="mb-3">
                                        <label asp-for="Email" class="form-label">Email *</label>
                                        <div class="input-group">
                                            <input asp-for="Email" class="form-control" type="email" />
                                            <span class="input-group-text">
                                                @if (Model.IsEmailConfirmed)
                                                {
                                                    <i class="fas fa-check-circle text-success" title="Email Verified"></i>
                                                }
                                                else
                                                {
                                                    <i class="fas fa-exclamation-circle text-warning" title="Email Not Verified"></i>
                                                }
                                            </span>
                                        </div>
                                        <span asp-validation-for="Email" class="text-danger"></span>
                                        @if (!Model.IsEmailConfirmed)
                                        {
                                            <div class="mt-2">
                                                <button type="button" class="btn btn-sm btn-outline-warning" onclick="sendVerificationEmail()">
                                                    <i class="fas fa-envelope me-1"></i>Verify Email
                                                </button>
                                                <small class="text-muted ms-2">Click to send verification email</small>
                                            </div>
                                        }
                                        else
                                        {
                                            <small class="text-success mt-1 d-block">
                                                <i class="fas fa-check-circle me-1"></i>Email verified
                                            </small>
                                        }
                                    </div>

                                    <div class="mb-3">
                                        <label asp-for="PhoneNumber" class="form-label">Phone Number</label>
                                        <input asp-for="PhoneNumber" class="form-control" placeholder="Enter phone number" maxlength="11" pattern="[0-9]{10,11}" title="Please enter a valid Malaysian phone number (10-11 digits)" />
                                        <span asp-validation-for="PhoneNumber" class="text-danger"></span>
                                        <small class="form-text text-muted">Enter a valid Malaysian phone number (10-11 digits)</small>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label asp-for="FirstName" class="form-label">First Name</label>
                                        <input asp-for="FirstName" class="form-control" placeholder="Enter first name" />
                                        <span asp-validation-for="FirstName" class="text-danger"></span>
                                    </div>

                                    <div class="mb-3">
                                        <label asp-for="LastName" class="form-label">Last Name</label>
                                        <input asp-for="LastName" class="form-control" placeholder="Enter last name" />
                                        <span asp-validation-for="LastName" class="text-danger"></span>
                                    </div>

                                    <div class="mb-3">
                                        <label asp-for="Address" class="form-label">Address</label>
                                        <textarea asp-for="Address" class="form-control" rows="3" placeholder="Enter your address"></textarea>
                                        <span asp-validation-for="Address" class="text-danger"></span>
                                    </div>

                                    <div class="mb-3">
                                        <label asp-for="DateOfBirth" class="form-label">Date of Birth</label>
                                        <input asp-for="DateOfBirth" class="form-control" type="date" id="dateOfBirth" max="@DateTime.Now.ToString("yyyy-MM-dd")" />
                                        <span asp-validation-for="DateOfBirth" class="text-danger"></span>
                                        <small class="form-text text-muted">Add your birthday to receive special offers and free desserts (members only)</small>
                                    </div>
                                </div>
                            </div>

                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <a asp-controller="Profile" asp-action="ChangePassword" class="btn btn-outline-warning me-md-2">
                                    <i class="fas fa-key me-2"></i>Change Password
                                </a>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>
                                    <span id="save-button-text">Update Profile</span>
                                    <span id="unsaved-indicator" class="ms-2" style="display: none;">
                                        <i class="fas fa-exclamation-triangle text-warning"></i>
                                    </span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Sidebar -->
            <div class="col-lg-4">
                @if (!ViewBag.IsAdmin)
                {
                    <!-- Points & Stats Card -->
                    <div class="card profile-sidebar-card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-chart-line me-2"></i>Points & Statistics
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="stats-grid">
                                <div class="stat-item">
                                    <div class="stat-icon bg-primary">
                                        <i class="fas fa-coins"></i>
                                    </div>
                                    <div class="stat-content">
                                        <div class="stat-value">@Model.Points</div>
                                        <div class="stat-label">Current Points</div>
                                    </div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-icon bg-success">
                                        <i class="fas fa-arrow-up"></i>
                                    </div>
                                    <div class="stat-content">
                                        <div class="stat-value">@Model.TotalPointsEarned</div>
                                        <div class="stat-label">Total Earned</div>
                                    </div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-icon bg-warning">
                                        <i class="fas fa-arrow-down"></i>
                                    </div>
                                    <div class="stat-content">
                                        <div class="stat-value">@Model.TotalPointsRedeemed</div>
                                        <div class="stat-label">Total Redeemed</div>
                                    </div>
                                </div>
                            </div>
                            <div class="text-center mt-3">
                                <a asp-controller="Deals" asp-action="Index" class="btn btn-primary btn-sm">
                                    <i class="fas fa-gift me-1"></i>Redeem Points
                                </a>
                            </div>
                        </div>
                    </div>
                }
                else
                {
                    <!-- Admin Quick Actions -->
                    <div class="card profile-sidebar-card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-tachometer-alt me-2"></i>Admin Dashboard
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="admin-actions-grid">
                                <a asp-controller="Admin" asp-action="Index" class="admin-action-btn">
                                    <i class="fas fa-tachometer-alt"></i>
                                    <span>Dashboard</span>
                                </a>
                                <a asp-controller="Admin" asp-action="Users" class="admin-action-btn">
                                    <i class="fas fa-users"></i>
                                    <span>Users</span>
                                </a>
                                <a asp-controller="Admin" asp-action="Orders" class="admin-action-btn">
                                    <i class="fas fa-shopping-cart"></i>
                                    <span>Orders</span>
                                </a>
                                <a asp-controller="Admin" asp-action="Reports" class="admin-action-btn">
                                    <i class="fas fa-chart-line"></i>
                                    <span>Reports</span>
                                </a>
                                <a asp-controller="AdminSupport" asp-action="Index" class="admin-action-btn">
                                    <i class="fas fa-headset"></i>
                                    <span>Support</span>
                                </a>
                                <a asp-controller="MenuItems" asp-action="Index" class="admin-action-btn">
                                    <i class="fas fa-utensils"></i>
                                    <span>Menu</span>
                                </a>
                            </div>
                        </div>
                    </div>
                }

                <!-- Quick Actions Card -->
                <div class="card profile-sidebar-card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-bolt me-2"></i>Quick Actions
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="quick-actions">
                            <a asp-controller="Orders" asp-action="History" class="quick-action-btn">
                                <i class="fas fa-history"></i>
                                <span>Order History</span>
                            </a>
                            <a asp-controller="Menu" asp-action="Index" class="quick-action-btn">
                                <i class="fas fa-utensils"></i>
                                <span>Browse Menu</span>
                            </a>
                            <a asp-action="Security" class="quick-action-btn">
                                <i class="fas fa-shield-alt"></i>
                                <span>Security</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script src="~/js/image-upload.js" asp-append-version="true"></script>
    <script>
        // Initialize profile image uploader
        document.addEventListener('DOMContentLoaded', function() {
            if (document.querySelector('.profile-image-section')) {
                // Check if ImageUploader is already initialized to prevent duplicate initialization
                if (!window.profileImageUploaderInitialized) {
                    new ImageUploader({
                        target: '.profile-image-section',
                        uploadUrl: '/Profile/UploadProfilePicture',
                        croppedUploadUrl: '/Profile/UploadCroppedProfilePicture',
                        hideUploadArea: true // Hide the drag-and-drop area
                    });
                    window.profileImageUploaderInitialized = true;
                }
            }
        });

        // Track form changes and warn before leaving
        let hasUnsavedChanges = false;
        let originalValues = {};

        document.addEventListener('DOMContentLoaded', function() {
            // Store original values
            const usernameInput = document.querySelector('input[name="UserName"]');
            const phoneNumberInput = document.querySelector('input[name="PhoneNumber"]');
            
            if (usernameInput) {
                originalValues.username = usernameInput.value || '';
            }
            if (phoneNumberInput) {
                originalValues.phoneNumber = phoneNumberInput.value || '';
            }

            // Add change listeners
            if (usernameInput) {
                usernameInput.addEventListener('input', checkForChanges);
            }
            if (phoneNumberInput) {
                phoneNumberInput.addEventListener('input', checkForChanges);
                
                // Restrict to numbers only and limit to 11 digits
                phoneNumberInput.addEventListener('input', function(e) {
                    // Remove any non-numeric characters
                    this.value = this.value.replace(/[^0-9]/g, '');
                    
                    // Limit to 11 digits
                    if (this.value.length > 11) {
                        this.value = this.value.substring(0, 11);
                    }
                });
                
                // Prevent non-numeric input on keypress
                phoneNumberInput.addEventListener('keypress', function(e) {
                    // Allow backspace, delete, tab, escape, enter
                    if ([8, 9, 27, 13, 46].indexOf(e.keyCode) !== -1 ||
                        // Allow Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
                        (e.keyCode === 65 && e.ctrlKey === true) ||
                        (e.keyCode === 67 && e.ctrlKey === true) ||
                        (e.keyCode === 86 && e.ctrlKey === true) ||
                        (e.keyCode === 88 && e.ctrlKey === true)) {
                        return;
                    }
                    // Ensure that it is a number and stop the keypress
                    if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
                        e.preventDefault();
                    }
                });
            }

            // Date of birth validation
            const dateOfBirthInput = document.getElementById('dateOfBirth');
            if (dateOfBirthInput) {
                dateOfBirthInput.addEventListener('change', function() {
                    const selectedDate = new Date(this.value);
                    const today = new Date();
                    
                    if (selectedDate > today) {
                        this.setCustomValidity('Date of birth cannot be in the future');
                        this.classList.add('is-invalid');
                    } else {
                        this.setCustomValidity('');
                        this.classList.remove('is-invalid');
                    }
                });
            }

            // Add beforeunload warning
            window.addEventListener('beforeunload', function(e) {
                if (hasUnsavedChanges) {
                    e.preventDefault();
                    e.returnValue = 'You have unsaved changes to your profile. Are you sure you want to leave?';
                    return e.returnValue;
                }
            });

            // Clear unsaved changes flag when form is submitted
            const form = document.querySelector('form[asp-action="Update"]');
            if (form) {
                form.addEventListener('submit', function() {
                    hasUnsavedChanges = false;
                });
            }
        });

        function checkForChanges() {
            const usernameInput = document.querySelector('input[name="UserName"]');
            const phoneNumberInput = document.querySelector('input[name="PhoneNumber"]');
            
            let currentUsername = usernameInput ? (usernameInput.value || '') : '';
            let currentPhoneNumber = phoneNumberInput ? (phoneNumberInput.value || '') : '';
            
            // Check if any values have changed
            hasUnsavedChanges = (
                currentUsername !== originalValues.username ||
                currentPhoneNumber !== originalValues.phoneNumber
            );

            // Update visual indicator
            const unsavedIndicator = document.getElementById('unsaved-indicator');
            const saveButtonText = document.getElementById('save-button-text');
            
            if (hasUnsavedChanges) {
                if (unsavedIndicator) unsavedIndicator.style.display = 'inline';
                if (saveButtonText) saveButtonText.textContent = 'Update Profile (Unsaved Changes)';
            } else {
                if (unsavedIndicator) unsavedIndicator.style.display = 'none';
                if (saveButtonText) saveButtonText.textContent = 'Update Profile';
            }
        }

        // Function to send verification email
        function sendVerificationEmail() {
            // Create a form dynamically and submit it
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '@Url.Action("SendVerificationEmail", "Profile")';
            
            // Add anti-forgery token
            const token = document.querySelector('input[name="__RequestVerificationToken"]');
            if (token) {
                const tokenInput = document.createElement('input');
                tokenInput.type = 'hidden';
                tokenInput.name = '__RequestVerificationToken';
                tokenInput.value = token.value;
                form.appendChild(tokenInput);
            }
            
            document.body.appendChild(form);
            form.submit();
        }
    </script>
} 