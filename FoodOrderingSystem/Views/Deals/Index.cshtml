@model FoodOrderingSystem.Controllers.DealsViewModel

@{
    ViewData["Title"] = "Points & Rewards";
}

@section Styles {
    <link rel="stylesheet" href="~/css/deals.css" asp-append-version="true" />
}

@if (Model.User == null)
{
    <!-- Login Required Section -->
    <div class="deals-hero-section deals-login-required">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-8 text-center">
                    <div class="hero-content">
                        <i class="fas fa-gift hero-icon"></i>
                        <h1 class="hero-title">Unlock Amazing Rewards</h1>
                        <p class="hero-subtitle">Login to start earning points and access exclusive deals!</p>
                        <div class="hero-actions">
                            <a href="/Identity/Account/Login" class="btn btn-primary btn-lg me-3">
                                <i class="fas fa-sign-in-alt me-2"></i>Login
                            </a>
                            <a href="/Identity/Account/Register" class="btn btn-outline-light btn-lg">
                                <i class="fas fa-user-plus me-2"></i>Register
                            </a>
                        </div>
                        <div class="hero-benefits">
                            <div class="benefit-item">
                                <i class="fas fa-coins text-warning"></i>
                                <span>Earn 1 point per RM1 spent</span>
                            </div>
                            <div class="benefit-item">
                                <i class="fas fa-gift text-success"></i>
                                <span>Redeem for free food</span>
                            </div>
                            <div class="benefit-item">
                                <i class="fas fa-ticket-alt text-info"></i>
                                <span>Exclusive promo codes</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}
else
{
    <!-- Hero Section with Points Display -->
    <div class="deals-hero-section">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-6">
                    <div class="hero-content">
                        <h1 class="hero-title">Welcome back, @(!string.IsNullOrEmpty(Model.User.FirstName) ? Model.User.FirstName : Model.User.UserName)!</h1>
                        <p class="hero-subtitle">Earn points on every order and redeem them for free food!</p>
                        
                        <!-- Points Display -->
                        <div class="points-display-card">
                            <div class="points-main">
                                <div class="points-icon">
                                    <i class="fas fa-coins"></i>
                                </div>
                                <div class="points-info">
                                    <span class="points-number">@Model.UserPoints</span>
                                    <span class="points-label">Available Points</span>
                                </div>
                            </div>
                            <div class="points-value">
                                <span class="value-amount">RM @Model.UserPoints.ToString("F2")</span>
                                <span class="value-label">Redeemable Value</span>
                            </div>
                        </div>
                        
                        <div class="hero-actions">
                            <a href="#redeem-section" class="btn btn-primary btn-lg me-3" onclick="scrollToRedeemSection(event)">
                                <i class="fas fa-gift me-2"></i>Claim Rewards
                            </a>
                            <a href="/Menu" class="btn btn-outline-light btn-lg">
                                <i class="fas fa-utensils me-2"></i>Order Now
                            </a>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="hero-visual">
                        <div class="points-animation">
                            <i class="fas fa-coins"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container deals-content">
        @Html.AntiForgeryToken()
        
        <!-- Error/Success Messages -->
        @if (TempData["ErrorMessage"] != null)
        {
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>@TempData["ErrorMessage"]
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        }
        @if (TempData["SuccessMessage"] != null)
        {
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="fas fa-check-circle me-2"></i>@TempData["SuccessMessage"]
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        }
        
        <!-- Points Summary Dashboard -->
        <div class="points-dashboard mb-5">
            <div class="row">
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="dashboard-card">
                        <div class="card-icon bg-primary">
                            <i class="fas fa-coins"></i>
                        </div>
                        <div class="card-content">
                            <h3>@Model.UserPoints</h3>
                            <p>Available Points</p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="dashboard-card">
                        <div class="card-icon bg-success">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="card-content">
                            <h3>RM @Model.UserPoints.ToString("F2")</h3>
                            <p>Redeemable Value</p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="dashboard-card">
                        <div class="card-icon bg-info">
                            <i class="fas fa-utensils"></i>
                        </div>
                        <div class="card-content">
                            <h3>@Model.RedeemableItems.Count</h3>
                            <p>Items Available</p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="dashboard-card">
                        <div class="card-icon bg-warning">
                            <i class="fas fa-ticket-alt"></i>
                        </div>
                        <div class="card-content">
                            <h3>@Model.PromoCodesWithUsage.Count</h3>
                            <p>Promo Codes</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- How Points Work Section -->
        <div class="section-container mb-5">
            <div class="section-header">
                <h2><i class="fas fa-info-circle text-info me-2"></i>How Points Work</h2>
                <p class="text-muted">Simple and rewarding points system for everyone!</p>
            </div>
            <div class="row">
                <div class="col-lg-10 mx-auto">
                    <div class="row">
                        <div class="col-md-4 mb-4">
                            <div class="text-center">
                                <div class="points-step-icon mb-3">
                                    <i class="fas fa-shopping-cart fa-3x text-primary"></i>
                                </div>
                                <h5>1. Order Food</h5>
                                <p class="text-muted">Place an order and earn 1 point for every RM1 you spend</p>
                            </div>
                        </div>
                        <div class="col-md-4 mb-4">
                            <div class="text-center">
                                <div class="points-step-icon mb-3">
                                    <i class="fas fa-coins fa-3x text-warning"></i>
                                </div>
                                <h5>2. Earn Points</h5>
                                <p class="text-muted">Points are automatically added to your account after each order</p>
                            </div>
                        </div>
                        <div class="col-md-4 mb-4">
                            <div class="text-center">
                                <div class="points-step-icon mb-3">
                                    <i class="fas fa-gift fa-3x text-success"></i>
                                </div>
                                <h5>3. Redeem Rewards</h5>
                                <p class="text-muted">Use your points to get free food items - 1 point = RM1 value</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Promo Codes Section -->
        @if (Model.PromoCodesWithUsage.Any())
        {
            <div class="section-container mb-5">
                <div class="section-header">
                    <h2><i class="fas fa-ticket-alt text-info me-2"></i>Your Available Promo Codes</h2>
                    <p class="text-muted">Use these codes at checkout for extra savings!</p>
                </div>
                <div class="row">
                    @foreach (var promoCode in Model.PromoCodesWithUsage)
                    {
                        <div class="col-lg-4 col-md-6 mb-4">
                            <div class="deal-card h-100 promo-code">
                                <div class="deal-badge">
                                    <span class="badge bg-info">PROMO CODE</span>
                                </div>
                                <div class="card-body text-center d-flex flex-column">
                                    <h5 class="card-title mt-3">@promoCode.Deal.Title</h5>
                                    <p class="card-text">@promoCode.Deal.Description</p>
                                    <div class="promo-code-display mb-3">
                                        <span class="promo-code-text">@promoCode.Deal.PromoCode</span>
                                        <button class="btn btn-sm btn-outline-secondary copy-btn" data-code="@promoCode.Deal.PromoCode">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                    <div class="discount-info mb-3">
                                        @if (promoCode.Deal.DiscountPercentage > 0)
                                        {
                                            <span class="discount-percentage">-@(promoCode.Deal.DiscountPercentage.ToString("0.##"))% OFF</span>
                                        }
                                        else if (promoCode.Deal.DiscountedPrice > 0)
                                        {
                                            <span class="discount-percentage">-RM@(promoCode.Deal.DiscountedPrice.ToString("F2")) OFF</span>
                                        }
                                    </div>
                                    <!-- Usage Information -->
                                    <div class="usage-info mb-3">
                                        <div class="usage-badge">
                                            <span class="badge bg-secondary">
                                                <i class="fas fa-sync-alt me-1"></i>Usage: @promoCode.UsageDisplay
                                            </span>
                                        </div>
                                        @if (promoCode.Deal.MinimumOrderAmount > 0)
                                        {
                                            <div class="mt-2">
                                                <small class="text-muted">
                                                    <i class="fas fa-info-circle me-1"></i>Min order: RM@(promoCode.Deal.MinimumOrderAmount.ToString("F2"))
                                                </small>
                                            </div>
                                        }
                                    </div>
                                    <div class="mt-auto">
                                        <p class="text-success small mb-0">
                                            <i class="fas fa-check-circle me-1"></i>Available for checkout
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        }
        else
        {
            <div class="section-container mb-5">
                <div class="section-header">
                    <h2><i class="fas fa-ticket-alt text-info me-2"></i>Promo Codes</h2>
                    <p class="text-muted">Your available promo codes will appear here</p>
                </div>
                <div class="row">
                    <div class="col-12">
                        <div class="text-center py-5">
                            <i class="fas fa-ticket-alt fa-3x text-muted mb-3"></i>
                            <h4 class="text-muted">No available promo codes</h4>
                            <p class="text-muted">
                                @if (Model.User != null)
                                {
                                    <span>You've either used all available promo codes or none are currently active. Check back later for new offers!</span>
                                }
                                else
                                {
                                    <span>Please <a href="/Identity/Account/Login" class="text-decoration-none">login</a> to see your available promo codes.</span>
                                }
                            </p>
                            @if (Model.User != null)
                            {
                                <a href="/Menu" class="btn btn-primary mt-3">
                                    <i class="fas fa-utensils me-2"></i>Start Ordering
                                </a>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }

        <!-- Points Redemption Section -->
        <div id="redeem-section" class="section-container mb-5">
            <div class="section-header">
                <h2><i class="fas fa-utensils text-success me-2"></i>Redeem Points for Free Food</h2>
                <p class="text-muted">Use your points to get free menu items! 1 Point = RM 1.00 value</p>
            </div>
            
            <!-- Quick Points Info -->
            <div class="row mb-4">
                <div class="col-lg-8 mx-auto">
                    <div class="deal-card points-redemption-header">
                        <div class="card-body text-center">
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <div class="points-display-large">
                                        <span class="points-number-large">@Model.UserPoints</span>
                                        <p class="text-muted mb-0">Available Points</p>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="text-start">
                                        <h6>How it works:</h6>
                                        <ul class="list-unstyled small">
                                            <li>✓ 1 Point = RM 1.00 value</li>
                                            <li>✓ Minimum 1 point per item</li>
                                            <li>✓ Get a redemption code instantly</li>
                                            <li>✓ Show code to claim your free item</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Available Items for Redemption -->
            <div class="row">
                @{
                    var categories = Model.RedeemableItems.GroupBy(item => item.Category?.Name ?? "Uncategorized").OrderBy(g => g.Key);
                }

                @foreach (var category in categories)
                {
                    <div class="col-12 mb-4">
                        <h4 class="category-title">@category.Key</h4>
                        <div class="row">
                            @foreach (var item in category.OrderBy(i => i.Name))
                            {
                                var pointsRequired = item.PointsPerItem > 0 ? item.PointsPerItem : (int)Math.Ceiling(item.Price);
                                var canRedeem = Model.UserPoints >= pointsRequired;
                                
                                <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
                                    <div class="deal-card redeem-item-card h-100">
                                        <div class="card-body text-center">
                                            <img src="@Url.Content(item.ImageUrl ?? "/images/placeholder.png")" 
                                                 class="img-fluid rounded mb-3" 
                                                 alt="@item.Name"
                                                 style="max-height: 120px; object-fit: cover;"
                                                 onerror="this.onerror=null;this.src='https://placehold.co/200x120/E8E8E8/B7B7B7?text=Image+Error';">
                                            
                                            <h6 class="card-title">@item.Name</h6>
                                            <p class="card-text small text-muted">@item.Description</p>
                                            
                                            <div class="points-required-badge mb-2">
                                                <span class="badge bg-primary">@pointsRequired Points</span>
                                            </div>
                                            
                                            <p class="text-muted small mb-3">
                                                <del>RM @item.Price.ToString("F2")</del> → <strong class="text-success">FREE!</strong>
                                            </p>
                                            
                                            <form asp-controller="Menu" asp-action="RedeemItem" method="post" class="mt-auto">
                                                <input type="hidden" name="menuItemId" value="@item.Id" />
                                                <button type="submit" class="btn btn-success btn-sm w-100" @(canRedeem ? "" : "disabled")>
                                                    @if (canRedeem)
                                                    {
                                                        <i class="fas fa-gift me-1"></i>@:Redeem Now
                                                    }
                                                    else
                                                    {
                                                        <i class="fas fa-lock me-1"></i>@:Need @(pointsRequired - Model.UserPoints) more points
                                                    }
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                }

                @if (!Model.RedeemableItems.Any())
                {
                    <div class="col-12">
                        <div class="text-center py-5">
                            <i class="fas fa-utensils fa-3x text-muted mb-3"></i>
                            <h4 class="text-muted">No items available for redemption</h4>
                            <p class="text-muted">Check back later for new items!</p>
                        </div>
                    </div>
                }
            </div>
        </div>

        <!-- Quick Actions Section -->
        <div class="section-container mb-5">
            <div class="section-header">
                <h2><i class="fas fa-bolt text-warning me-2"></i>Quick Actions</h2>
                <p class="text-muted">Earn more points and maximize your rewards!</p>
            </div>
            <div class="row">
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="quick-action-card">
                        <div class="action-icon bg-primary">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                        <h5>Order Food</h5>
                        <p>Earn 1 point for every RM1 spent</p>
                        <a href="/Menu" class="btn btn-primary btn-sm">Start Ordering</a>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="quick-action-card">
                        <div class="action-icon bg-success">
                            <i class="fas fa-star"></i>
                        </div>
                        <h5>Write Reviews</h5>
                        <p>Earn 5 points for each review</p>
                        <a href="/Reviews/Create" class="btn btn-success btn-sm">Write Review</a>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="quick-action-card">
                        <div class="action-icon bg-info">
                            <i class="fas fa-user-plus"></i>
                        </div>
                        <h5>Refer Friends</h5>
                        <p>Earn 50 points per referral</p>
                        <a asp-controller="Profile" asp-action="GetReferralCode" class="btn btn-info btn-sm">Get Referral Code</a>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="quick-action-card">
                        <div class="action-icon bg-warning">
                            <i class="fas fa-birthday-cake"></i>
                        </div>
                        <h5>Birthday Bonus</h5>
                        <p>Get 100 bonus points on your birthday</p>
                        <a href="@Url.Action("ClaimBirthdayBenefit", "Deals")" class="btn btn-warning btn-sm">Claim Bonus</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@section Scripts {
    <script src="~/js/deals.js" asp-append-version="true"></script>
    <script>
        // Smooth scroll to redeem section
        function scrollToRedeemSection(event) {
            event.preventDefault();
            const target = document.getElementById('redeem-section');
            if (target) {
                target.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        }

        // Show loading state
        function showLoading(button) {
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
            button.disabled = true;
            button.dataset.originalText = originalText;
        }
        
        // Hide loading state
        function hideLoading(button) {
            button.innerHTML = button.dataset.originalText || button.innerHTML;
            button.disabled = false;
        }
        
        // Add loading states to birthday benefit button
        document.addEventListener('click', function(e) {
            if (e.target.closest('a[href*="ClaimBirthdayBenefit"]')) {
                const btn = e.target.closest('a');
                showLoading(btn);
            }
        });
        
        document.addEventListener('DOMContentLoaded', function() {
            // Handle copy promo code buttons
            const copyButtons = document.querySelectorAll('.copy-btn');
            
            copyButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const promoCode = this.getAttribute('data-code');
                    
                    // Copy to clipboard
                    navigator.clipboard.writeText(promoCode).then(function() {
                        // Show success feedback
                        const originalIcon = button.innerHTML;
                        button.innerHTML = '<i class="fas fa-check"></i>';
                        button.classList.add('btn-success');
                        button.classList.remove('btn-outline-secondary');
                        
                        // Reset after 2 seconds
                        setTimeout(() => {
                            button.innerHTML = originalIcon;
                            button.classList.remove('btn-success');
                            button.classList.add('btn-outline-secondary');
                        }, 2000);
                    }).catch(function(err) {
                        console.error('Could not copy text: ', err);
                    });
                });
            });

            // Add animation to points display
            const pointsNumber = document.querySelector('.points-number-large');
            if (pointsNumber) {
                const finalValue = parseInt(pointsNumber.textContent);
                let currentValue = 0;
                const increment = Math.ceil(finalValue / 50);
                
                const timer = setInterval(() => {
                    currentValue += increment;
                    if (currentValue >= finalValue) {
                        currentValue = finalValue;
                        clearInterval(timer);
                    }
                    pointsNumber.textContent = currentValue;
                }, 50);
            }
        });
    </script>
}