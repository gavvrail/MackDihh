@model FoodOrderingSystem.Controllers.DealsViewModel

@{
    ViewData["Title"] = "Hot Deals & Promotions";
}

@section Styles {
    <link rel="stylesheet" href="~/css/deals.css" asp-append-version="true" />
}

<!-- Page Header -->
<div class="deals-full-width @(Model.User == null ? "deals-login-required" : "")">
    <div class="container-fluid">
        @if (Model.User != null)
        {
            <h1>@ViewData["Title"]</h1>
            <p class="lead">Don't miss out on our amazing food offers!</p>
            
            <div class="user-status-badges">
                @if (Model.IsMember)
                {
                    <span class="badge bg-gold me-2">
                        <i class="fas fa-crown me-1"></i>Member
                    </span>
                }
                @if (Model.IsStudentVerified)
                {
                    <span class="badge bg-primary me-2">
                        <i class="fas fa-graduation-cap me-1"></i>Student
                    </span>
                }
                <div class="d-flex align-items-center">
                    <span class="me-2 fw-bold">Your Points:</span>
                    <span class="badge bg-success">
                        <i class="fas fa-coins me-1"></i>@Model.UserPoints Points
                    </span>
                </div>
            </div>
        }
        else
        {
            <h1>Rewards & Promotions</h1>
            <p class="lead">Login to access exclusive deals and rewards!</p>
        }
    </div>
</div>

<!-- Main Content -->
<div class="container deals-content">
    @Html.AntiForgeryToken()
    @if (Model.User == null)
    {
        <!-- Login Prompt for Unauthenticated Users -->
        <div class="login-prompt-section">
            <div class="container">
                <div class="row justify-content-center">
                    <div class="col-md-8 col-lg-6">
                        <div class="card shadow-lg border-0">
                            <div class="card-body p-5 text-center">
                                <div class="mb-4">
                                    <i class="fas fa-lock fa-3x text-primary mb-3"></i>
                                    <h3 class="text-primary">Login Required</h3>
                                    <p class="text-muted">Please log in to access our exclusive deals and rewards!</p>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <a href="/Identity/Account/Login" class="btn btn-primary btn-lg w-100">
                                            <i class="fas fa-sign-in-alt me-2"></i>LOGIN
                                        </a>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <a href="/Identity/Account/Register" class="btn btn-outline-primary btn-lg w-100">
                                            <i class="fas fa-user-plus me-2"></i>Register
                                        </a>
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <p class="text-muted small">
                                        <i class="fas fa-info-circle me-1"></i>
                                        New users get bonus points and exclusive member benefits!
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <!-- Points & Rewards Section for Authenticated Users -->
        <div class="section-container mb-3">
            <div class="section-header d-flex justify-content-between align-items-center">
                <div>
                    <h2><i class="fas fa-star text-warning me-2"></i>Points & Rewards</h2>
                    <p class="text-muted">Redeem your points for exclusive rewards!</p>
                </div>
                <a href="@Url.Action("ClaimPoints", "Deals")" class="btn btn-primary btn-lg">
                    <i class="fas fa-gift me-2"></i>Claim Points & Rewards
                </a>
            </div>
        </div>

        <!-- Birthday Benefits Section for Members -->
        @if (Model.User.IsMember && Model.User.MemberExpiryDate > DateTime.UtcNow && Model.User.DateOfBirth.HasValue)
        {
            var today = DateTime.UtcNow;
            var birthday = Model.User.DateOfBirth.Value;
            var isBirthdayMonth = today.Month == birthday.Month && today.Year == birthday.Year;
            
            if (isBirthdayMonth)
            {
                <div class="section-container mb-3">
                    <div class="section-header">
                        <h2><i class="fas fa-birthday-cake text-danger me-2"></i>🎂 Birthday Special! 🎉</h2>
                        <p class="text-muted">It's your birthday month! Claim your special birthday benefits!</p>
                    </div>
                    <div class="row">
                        <div class="col-lg-8 mx-auto">
                            <div class="deal-card birthday-benefit">
                                <div class="deal-badge">
                                    <span class="badge bg-danger">BIRTHDAY SPECIAL</span>
                                </div>
                                <div class="card-body text-center">
                                    <h5 class="card-title">Happy Birthday! 🎂</h5>
                                    <p class="card-text">As a valued member, you're entitled to special birthday benefits!</p>
                                    <div class="birthday-benefits mb-4">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="benefit-item">
                                                    <i class="fas fa-coins text-warning fa-2x mb-2"></i>
                                                    <h6>100 Bonus Points</h6>
                                                    <p>Get 100 free points as a birthday gift!</p>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="benefit-item">
                                                    <i class="fas fa-ice-cream text-primary fa-2x mb-2"></i>
                                                    <h6>Free Dessert</h6>
                                                    <p>Show your birthday benefit code for a free dessert!</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <a asp-action="ClaimBirthdayBenefit" class="btn btn-danger btn-lg">
                                        <i class="fas fa-gift me-2"></i>Claim Birthday Benefits
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        }

    <!-- Promo Codes Section -->
    @if (Model.PromoCodes.Any())
    {
        <div class="section-container mb-5">
            <div class="section-header">
                <h2><i class="fas fa-ticket-alt text-info me-2"></i>Your Available Promo Codes</h2>
                <p class="text-muted">Use these codes at checkout for extra savings!</p>
            </div>
            <div class="row">
                @foreach (var deal in Model.PromoCodes)
                {
                    <div class="col-lg-4 col-md-6 mb-4">
                        <div class="deal-card h-100 promo-code">
                            <div class="deal-badge">
                                <span class="badge bg-info">PROMO CODE</span>
                            </div>
                            <div class="card-body text-center d-flex flex-column">
                                <h5 class="card-title mt-3">@deal.Title</h5>
                                <p class="card-text">@deal.Description</p>
                                <div class="promo-code-display mb-3">
                                    <span class="promo-code-text">@deal.PromoCode</span>
                                    <button class="btn btn-sm btn-outline-secondary copy-btn" data-code="@deal.PromoCode">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                                <div class="discount-info mb-3">
                                    <span class="discount-percentage">-@deal.DiscountPercentage% OFF</span>
                                </div>
                                <div class="mt-auto">
                                    <p class="text-success small mb-0">
                                        <i class="fas fa-check-circle me-1"></i>Available for checkout
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    }
    else if (Model.User != null)
    {
        <div class="section-container mb-5">
            <div class="section-header">
                <h2><i class="fas fa-ticket-alt text-info me-2"></i>Promo Codes</h2>
                <p class="text-muted">Your available promo codes will appear here</p>
            </div>
            <div class="row">
                <div class="col-12">
                    <div class="text-center py-5">
                        <i class="fas fa-ticket-alt fa-3x text-muted mb-3"></i>
                        <h4 class="text-muted">No available promo code for you</h4>
                        <p class="text-muted">Check back later for new promo codes or contact support for assistance.</p>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Referral Bonus Section -->
    @if (Model.ReferralBonus != null)
    {
        <div class="section-container mb-5">
            <div class="section-header">
                <h2><i class="fas fa-users text-success me-2"></i>Referral Program</h2>
                <p class="text-muted">Refer friends and earn rewards!</p>
            </div>
            <div class="row">
                <div class="col-lg-8 mx-auto">
                    <div class="deal-card referral-bonus">
                        <div class="deal-badge">
                            <span class="badge bg-success">REFERRAL BONUS</span>
                        </div>
                        <div class="card-body text-center">
                            <h5 class="card-title">@Model.ReferralBonus.Title</h5>
                            <p class="card-text">@Model.ReferralBonus.Description</p>
                            <div class="referral-benefits mb-4">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="benefit-item">
                                            <i class="fas fa-gift text-success fa-2x mb-2"></i>
                                            <h6>You Get</h6>
                                            <p>RM10 credit for each friend who joins</p>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="benefit-item">
                                            <i class="fas fa-heart text-danger fa-2x mb-2"></i>
                                            <h6>Your Friend Gets</h6>
                                            <p>RM5 credit on their first order</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <a asp-action="ReferralProgram" class="btn btn-success btn-lg">
                                <i class="fas fa-share me-2"></i>Start Referring
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }



    <!-- Points Redemption Section (Free Food) -->
    @if (Model.User != null)
    {
        <div class="section-container mb-5">
            <div class="section-header">
                <h2><i class="fas fa-utensils text-success me-2"></i>Redeem Points for Free Food</h2>
                <p class="text-muted">Use your points to get free menu items! 1 Point = RM 1.00 value</p>
            </div>
            
            <!-- Points Display Card -->
            <div class="row mb-4">
                <div class="col-lg-8 mx-auto">
                    <div class="deal-card points-redemption-header">
                        <div class="card-body text-center">
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <div class="points-display-large">
                                        <span class="points-number-large">@Model.UserPoints</span>
                                        <p class="text-muted mb-0">Available Points</p>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="text-start">
                                        <h6>How it works:</h6>
                                        <ul class="list-unstyled small">
                                            <li>✓ 1 Point = RM 1.00 value</li>
                                            <li>✓ Minimum 1 point per item</li>
                                            <li>✓ Get a redemption code instantly</li>
                                            <li>✓ Show code to claim your free item</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Available Items for Redemption -->
            <div class="row">
                @{
                    var categories = Model.RedeemableItems.GroupBy(item => item.Category?.Name ?? "Uncategorized").OrderBy(g => g.Key);
                }

                @foreach (var category in categories)
                {
                    <div class="col-12 mb-4">
                        <h4 class="category-title">@category.Key</h4>
                        <div class="row">
                            @foreach (var item in category.OrderBy(i => i.Name))
                            {
                                // Calculate points required based on price (1 point = RM 1.00)
                                // If PointsPerItem is set, use it; otherwise calculate from price
                                var pointsRequired = item.PointsPerItem > 0 ? item.PointsPerItem : (int)Math.Ceiling(item.Price);
                                var canRedeem = Model.UserPoints >= pointsRequired;
                                
                                <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
                                    <div class="deal-card redeem-item-card h-100">
                                        <div class="card-body text-center">
                                            <img src="@Url.Content(item.ImageUrl ?? "/images/placeholder.png")" 
                                                 class="img-fluid rounded mb-3" 
                                                 alt="@item.Name"
                                                 style="max-height: 120px; object-fit: cover;"
                                                 onerror="this.onerror=null;this.src='https://placehold.co/200x120/E8E8E8/B7B7B7?text=Image+Error';">
                                            
                                            <h6 class="card-title">@item.Name</h6>
                                            <p class="card-text small text-muted">@item.Description</p>
                                            
                                            <div class="points-required-badge mb-2">
                                                <span class="badge bg-primary">@pointsRequired Points</span>
                                            </div>
                                            
                                            <p class="text-muted small mb-3">
                                                <del>RM @item.Price.ToString("F2")</del> → <strong class="text-success">FREE!</strong>
                                            </p>
                                            
                                            @if (Model.User.IsMember && Model.User.MemberExpiryDate > DateTime.UtcNow)
                                            {
                                                <form asp-controller="Menu" asp-action="RedeemItem" method="post" class="mt-auto">
                                                    <input type="hidden" name="menuItemId" value="@item.Id" />
                                                    <button type="submit" class="btn btn-success btn-sm w-100" @(canRedeem ? "" : "disabled")>
                                                        @if (canRedeem)
                                                        {
                                                            <i class="fas fa-gift me-1"></i>@("Redeem Now")
                                                        }
                                                        else
                                                        {
                                                            <i class="fas fa-lock me-1"></i>@($"Need {pointsRequired - Model.UserPoints} more points")
                                                        }
                                                    </button>
                                                </form>
                                            }
                                            else
                                            {
                                                <a asp-action="MemberPurchase" class="btn btn-warning btn-sm w-100 mt-auto">
                                                    <i class="fas fa-crown me-1"></i>Become Member to Redeem
                                                </a>
                                            }
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                }

                @if (!Model.RedeemableItems.Any())
                {
                    <div class="col-12">
                        <div class="text-center py-5">
                            <i class="fas fa-utensils fa-3x text-muted mb-3"></i>
                            <h4 class="text-muted">No items available for redemption</h4>
                            <p class="text-muted">Check back later for new items!</p>
                        </div>
                    </div>
                }
            </div>
        </div>
    }
    }
</div>


@section Scripts {
    <script src="~/js/deals.js" asp-append-version="true"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Handle copy promo code buttons
            const copyButtons = document.querySelectorAll('.copy-btn');
            
            copyButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const promoCode = this.getAttribute('data-code');
                    
                    // Copy to clipboard
                    navigator.clipboard.writeText(promoCode).then(function() {
                        // Show success feedback
                        const originalIcon = button.innerHTML;
                        button.innerHTML = '<i class="fas fa-check"></i>';
                        button.classList.add('btn-success');
                        button.classList.remove('btn-outline-secondary');
                        
                        // Reset after 2 seconds
                        setTimeout(() => {
                            button.innerHTML = originalIcon;
                            button.classList.remove('btn-success');
                            button.classList.add('btn-outline-secondary');
                        }, 2000);
                    }).catch(function(err) {
                        console.error('Could not copy text: ', err);
                    });
                });
            });
        });
    </script>
}
