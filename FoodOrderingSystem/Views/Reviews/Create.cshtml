@model FoodOrderingSystem.Controllers.CreateReviewViewModel

@{
    ViewData["Title"] = $"Write Review - {Model.MenuItem.Name}";
}

@Html.AntiForgeryToken()

@section Styles {
    <link rel="stylesheet" href="~/css/reviews.css" asp-append-version="true" />
}

<div class="reviews-container">
    <div class="container">
        <!-- Product Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-3">
                                <img src="@Url.Content(Model.MenuItem.ImageUrl ?? "/images/placeholder.png")" 
                                     class="img-fluid rounded" 
                                     alt="@Model.MenuItem.Name"
                                     style="height: 150px; object-fit: cover;">
                            </div>
                            <div class="col-md-6">
                                <h2 class="mb-2">@Model.MenuItem.Name</h2>
                                <p class="text-muted mb-2">@Model.MenuItem.Category?.Name</p>
                                <p class="mb-3">@Model.MenuItem.Description</p>
                            </div>
                            <div class="col-md-3 text-end">
                                <h2 class="mb-3 fw-bold product-price-clean">RM@(Model.MenuItem.Price.ToString("F2"))</h2>
                                <a asp-controller="Reviews" asp-action="Product" asp-route-menuItemId="@Model.MenuItem.Id" class="btn btn-outline-primary">
                                    <i class="fas fa-arrow-left me-1"></i>Back to Reviews
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Review Form -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h3 class="mb-4">Write Your Review</h3>
                        
                        <form asp-action="Create" asp-controller="Reviews" asp-route-menuItemId="@Model.MenuItemId" method="post">
                            <input type="hidden" asp-for="MenuItemId" />
                            
                            <!-- Rating -->
                            <div class="mb-4">
                                <label class="form-label fw-bold">Rating *</label>
                                <div class="rating-system-new">
                                    <div class="rating-options">
                                        <label class="rating-option">
                                            <input type="radio" name="Rating" value="1" />
                                            <div class="rating-display">
                                                <div class="stars">★</div>
                                                <div class="label">Poor</div>
                                            </div>
                                        </label>
                                        <label class="rating-option">
                                            <input type="radio" name="Rating" value="2" />
                                            <div class="rating-display">
                                                <div class="stars">★★</div>
                                                <div class="label">Fair</div>
                                            </div>
                                        </label>
                                        <label class="rating-option">
                                            <input type="radio" name="Rating" value="3" />
                                            <div class="rating-display">
                                                <div class="stars">★★★</div>
                                                <div class="label">Good</div>
                                            </div>
                                        </label>
                                        <label class="rating-option">
                                            <input type="radio" name="Rating" value="4" />
                                            <div class="rating-display">
                                                <div class="stars">★★★★</div>
                                                <div class="label">Very Good</div>
                                            </div>
                                        </label>
                                        <label class="rating-option">
                                            <input type="radio" name="Rating" value="5" />
                                            <div class="rating-display">
                                                <div class="stars">★★★★★</div>
                                                <div class="label">Excellent</div>
                                            </div>
                                        </label>
                                    </div>
                                    <div class="selected-rating" id="selectedRatingDisplay" style="display: none;">
                                        <i class="fas fa-check-circle text-success me-2"></i>
                                        <span id="selectedRatingText"></span>
                                    </div>
                                </div>
                                <span asp-validation-for="Rating" class="text-danger" style="display: none;"></span>
                            </div>

                            <!-- Comment -->
                            <div class="mb-4">
                                <label asp-for="Comment" class="form-label fw-bold">Review Comment</label>
                                <textarea asp-for="Comment" class="form-control" rows="5" 
                                          placeholder="Share your experience with this product..."></textarea>
                                <span asp-validation-for="Comment" class="text-danger" style="display: none;"></span>
                                <div class="form-text">Maximum 1000 characters</div>
                            </div>

                            <!-- Anonymous Option -->
                            <div class="mb-4">
                                <div class="form-check">
                                    <input asp-for="IsAnonymous" class="form-check-input" type="checkbox" id="isAnonymous" />
                                    <label class="form-check-label" for="isAnonymous">
                                        Post this review anonymously
                                    </label>
                                </div>
                            </div>

                            <!-- Anonymous Name -->
                            <div class="mb-4" id="anonymousNameSection" style="display: none;">
                                <label asp-for="AnonymousName" class="form-label fw-bold">Display Name</label>
                                <input asp-for="AnonymousName" class="form-control" 
                                       placeholder="Enter a display name for your anonymous review" />
                                <span asp-validation-for="AnonymousName" class="text-danger" style="display: none;"></span>
                                <div class="form-text">This name will be shown instead of your username</div>
                            </div>

                            <!-- Submit Buttons -->
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary btn-review-submit">
                                    <i class="fas fa-paper-plane me-1"></i>Submit Review
                                </button>
                                <a asp-controller="Reviews" asp-action="Product" asp-route-menuItemId="@Model.MenuItem.Id" class="btn btn-outline-secondary btn-review-cancel">
                                    Cancel
                                </a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Ultra Simple Review System - Completely Rebuilt
        document.addEventListener('DOMContentLoaded', function() {
            
            // Hide validation messages initially
            document.querySelectorAll('.text-danger').forEach(msg => {
                msg.style.display = 'none';
            });
            
            // New Radio Button Rating System
            const radioButtons = document.querySelectorAll('input[name="Rating"]');
            const ratingDisplay = document.getElementById('selectedRatingDisplay');
            const ratingText = document.getElementById('selectedRatingText');
            
            // Rating system initialized
            
            // Handle radio button changes
            radioButtons.forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.checked) {
                        const rating = parseInt(this.value);
                        const labels = ['', 'Poor', 'Fair', 'Good', 'Very Good', 'Excellent'];
                        
                        // Show feedback
                        ratingText.textContent = `You selected ${rating}/5 stars (${labels[rating]})`;
                        ratingDisplay.style.display = 'block';
                        
                        // Clear validation errors
                        document.querySelectorAll('span[asp-validation-for="Rating"]').forEach(span => {
                            span.style.display = 'none';
                        });
                    }
                });
            });
            
            // Anonymous checkbox handler
            const anonymousCheckbox = document.getElementById('isAnonymous');
            const anonymousSection = document.getElementById('anonymousNameSection');
            
            if (anonymousCheckbox && anonymousSection) {
                anonymousCheckbox.addEventListener('change', function() {
                    if (this.checked) {
                        anonymousSection.style.display = 'block';
                        const nameInput = document.querySelector('input[name="AnonymousName"]');
                        if (nameInput) {
                            setTimeout(() => nameInput.focus(), 100);
                        }
                    } else {
                        anonymousSection.style.display = 'none';
                        const nameInput = document.querySelector('input[name="AnonymousName"]');
                        if (nameInput) {
                            nameInput.value = '';
                        }
                    }
                });
            }
            
            // Simple Form Submission Handler
            const form = document.querySelector('form');
            const submitBtn = document.querySelector('.btn-review-submit');
            
            // Form submission setup
            
            if (form && submitBtn) {
                // Remove any existing event listeners by cloning the button
                const newSubmitBtn = submitBtn.cloneNode(true);
                submitBtn.parentNode.replaceChild(newSubmitBtn, submitBtn);
                
                newSubmitBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Check rating
                    const selectedRadio = document.querySelector('input[name="Rating"]:checked');
                    if (!selectedRadio) {
                        alert('Please select a rating by clicking one of the rating options above.');
                        return false;
                    }
                    
                    // Check anonymous name if needed
                    const anonymousCheckbox = document.getElementById('isAnonymous');
                    const anonymousNameInput = document.querySelector('input[name="AnonymousName"]');
                    
                    if (anonymousCheckbox && anonymousCheckbox.checked) {
                        if (!anonymousNameInput || !anonymousNameInput.value.trim()) {
                            alert('Please enter a display name for your anonymous review.');
                            if (anonymousNameInput) anonymousNameInput.focus();
                            return false;
                        }
                    }
                    
                    // All validation passed - submit the form
                    
                    // Show loading state
                    const originalText = newSubmitBtn.innerHTML;
                    newSubmitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Submitting...';
                    newSubmitBtn.disabled = true;
                    
                    // Submit the form
                    
                    try {
                        // Submit form directly
                        form.submit();
                        
                        // Add a timeout to handle successful submission
                        setTimeout(() => {
                            if (document.querySelector('.btn-review-submit')) {
                                const menuItemId = document.querySelector('input[name="MenuItemId"]')?.value;
                                window.location.href = `/Reviews/Product?menuItemId=${menuItemId}`;
                            }
                        }, 3000);
                    } catch (error) {
                        console.error('Form submission error:', error);
                        
                        // Try alternative submission method
                        try {
                            const formData = new FormData(form);
                            formData.set('Rating', selectedRadio.value);
                            
                            fetch(form.action, {
                                method: 'POST',
                                body: formData
                            }).then(response => {
                                if (response.redirected) {
                                    window.location.href = response.url;
                                } else if (response.ok) {
                                    const menuItemId = document.querySelector('input[name="MenuItemId"]')?.value;
                                    window.location.href = `/Reviews/Product?menuItemId=${menuItemId}`;
                                } else {
                                    throw new Error('Server error');
                                }
                            }).catch(fetchError => {
                                newSubmitBtn.innerHTML = originalText;
                                newSubmitBtn.disabled = false;
                                alert('Failed to submit review. Please try again.');
                            });
                        } catch (altError) {
                            console.error('Alternative submission error:', altError);
                            newSubmitBtn.innerHTML = originalText;
                            newSubmitBtn.disabled = false;
                            alert('There was an error submitting your review. Please try again.');
                        }
                    }
                });
                
                // Submit button configured
            }
            
            // Debug buttons removed for production
        });
    </script>
}
